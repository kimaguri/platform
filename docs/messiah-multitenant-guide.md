# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –ú—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π –ü–ª–∞—Ç—Ñ–æ—Ä–º—ã "–ú–µ—Å—Å–∏—è"
**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞–º–∏**

**–î–∞—Ç–∞:** 24 –∏—é–ª—è 2025  
**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** Admin DB (Supabase) + Tenant DB (per-tenant) + –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã  
**–°—Ç–∏–ª—å:** –ß–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –±–µ–∑ –∫–ª–∞—Å—Å–æ–≤

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
1. [–û–±—â–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
2. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Admin DB](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-admin-db)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Tenant DB](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-tenant-db)
4. [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã](#—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ-–∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã)
5. [SQL –°–∫—Ä–∏–ø—Ç—ã](#sql-—Å–∫—Ä–∏–ø—Ç—ã)
6. [Flow –†–∞–±–æ—Ç—ã](#flow-—Ä–∞–±–æ—Ç—ã)
7. [–†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ü–æ–ª—è](#—Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ-–ø–æ–ª—è)
8. [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ)
9. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)

---

## üîß –û–±—â–∞—è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           API Gateway                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ        Tenant Management                ‚îÇ
‚îÇ   (—á–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –±–µ–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Admin DB (Supabase)  ‚îÇ  Tenant DB     ‚îÇ
‚îÇ  - tenants            ‚îÇ  (per-tenant)  ‚îÇ
‚îÇ  - configs            ‚îÇ  - –¥–∞–Ω–Ω—ã–µ      ‚îÇ
‚îÇ  - extensible_fields  ‚îÇ  - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å**: –í—Å—ë —á–µ—Ä–µ–∑ —á–∏—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- **–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã**: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑–Ω—ã–º –ë–î
- **–ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è**: Repository pattern —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ù–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–∞

---

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Admin DB (Supabase)

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

```sql
-- –¢–∞–±–ª–∏—Ü–∞ —Ç–µ–Ω–∞–Ω—Ç–æ–≤
create table tenants (
  id uuid primary key default gen_random_uuid(),
  tenant_id text unique not null,
  name text not null,
  slug text unique not null,
  status text check (status in ('active', 'inactive', 'suspended')) default 'active',
  contact_email text,
  contact_name text,
  settings jsonb default '{}',
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π Supabase –¥–ª—è —Ç–µ–Ω–∞–Ω—Ç–æ–≤
create table tenant_supabase_configs (
  id uuid primary key default gen_random_uuid(),
  tenant_id text references tenants(tenant_id) on delete cascade,
  supabase_project_id text not null,
  supabase_url text not null,
  anon_key text not null,
  service_key text not null,
  region text default 'us-east-1',
  plan text check (plan in ('free', 'pro', 'team', 'enterprise')) default 'free',
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ø–æ–ª—è
create table extension_field_definitions (
  id bigserial primary key,
  tenant_id text references tenants(tenant_id) on delete cascade,
  entity_table text not null,
  field_name text not null,
  field_type text check (field_type in ('text', 'number', 'boolean', 'date', 'json', 'select')),
  display_name text not null,
  description text,
  is_required boolean default false,
  is_searchable boolean default true,
  is_filterable boolean default true,
  is_sortable boolean default false,
  default_value text,
  validation_rules jsonb default '{}',
  ui_config jsonb default '{}',
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  unique(tenant_id, entity_table, field_name)
);

-- –ò–Ω–¥–µ–∫—Å—ã
create index idx_tenants_status on tenants(status);
create index idx_tenants_slug on tenants(slug);
create index idx_tenant_configs_tenant on tenant_supabase_configs(tenant_id);
create index idx_extension_fields_tenant on extension_field_definitions(tenant_id, entity_table);
```

---

## üè¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Tenant DB (per-tenant)

### –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –ë–î:

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –ë–î –¥–ª—è —Ç–µ–Ω–∞–Ω—Ç–∞
create database tenant_{tenant_id};

-- –í–Ω—É—Ç—Ä–∏ tenant DB:
create table clients (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  email text unique,
  phone text,
  custom_fields jsonb default '{}',
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table projects (
  id uuid primary key default gen_random_uuid(),
  client_id uuid references clients(id),
  name text not null,
  status text default 'active',
  custom_fields jsonb default '{}',
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table activities (
  id uuid primary key default gen_random_uuid(),
  project_id uuid references projects(id),
  type text not null,
  description text,
  custom_fields jsonb default '{}',
  created_at timestamptz default now()
);
```

---

## üîå –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã

### –§–∞–±—Ä–∏–∫–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤:

```typescript
// src/services/tenant-management/src/connectors/factory.ts
import { createSupabaseConnector } from './supabase';
import { createPostgresConnector } from './postgres';
import type { DatabaseConnector } from './types';

export type ConnectorType = 'supabase' | 'postgres' | 'mongodb';

export type DatabaseConfig = {
  type: ConnectorType;
  url: string;
  key?: string;
  database?: string;
};

export type DatabaseConnector = {
  query: (sql: string, params?: any[]) => Promise<any[]>;
  insert: (table: string, data: Record<string, any>) => Promise<any>;
  update: (table: string, data: Record<string, any>, where: Record<string, any>) => Promise<any>;
  delete: (table: string, where: Record<string, any>) => Promise<any>;
  close: () => Promise<void>;
};

export const createConnector = (config: DatabaseConfig): DatabaseConnector => {
  switch (config.type) {
    case 'supabase':
      return createSupabaseConnector(config);
    case 'postgres':
      return createPostgresConnector(config);
    default:
      throw new Error(`Unsupported connector type: ${config.type}`);
  }
};
```

### Supabase –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä:

```typescript
// src/services/tenant-management/src/connectors/supabase.ts
import { createClient, SupabaseClient } from '@supabase/supabase-js';
import type { DatabaseConnector, DatabaseConfig } from './types';

export const createSupabaseConnector = (config: DatabaseConfig): DatabaseConnector => {
  const client: SupabaseClient = createClient(config.url, config.key!);
  
  return {
    query: async (sql: string, params?: any[]) => {
      const { data, error } = await client.rpc('exec_sql', { sql, params });
      if (error) throw error;
      return data;
    },
    
    insert: async (table: string, data: Record<string, any>) => {
      const { data: result, error } = await client.from(table).insert(data).select().single();
      if (error) throw error;
      return result;
    },
    
    update: async (table: string, data: Record<string, any>, where: Record<string, any>) => {
      const { data: result, error } = await client.from(table).update(data).match(where).select();
      if (error) throw error;
      return result;
    },
    
    delete: async (table: string, where: Record<string, any>) => {
      const { error } = await client.from(table).delete().match(where);
      if (error) throw error;
    },
    
    close: async () => {
      // Supabase –∫–ª–∏–µ–Ω—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è
    }
  };
};
```

---

## üìä SQL –°–∫—Ä–∏–ø—Ç—ã

### –°–∫—Ä–∏–ø—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Admin DB:

```sql
-- init_admin_db.sql
-- –ó–∞–ø—É—Å–∫–∞—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

-- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
CREATE SCHEMA IF NOT EXISTS tenant_management;

-- –¢–∞–±–ª–∏—Ü–∞ tenants
CREATE TABLE IF NOT EXISTS tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  status TEXT CHECK (status IN ('active', 'inactive', 'suspended')) DEFAULT 'active',
  contact_email TEXT,
  contact_name TEXT,
  settings JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
create table if not exists tenant_supabase_configs (
  id uuid primary key default gen_random_uuid(),
  tenant_id text references tenants(tenant_id) on delete cascade,
  supabase_project_id text not null,
  supabase_url text not null,
  anon_key text not null,
  service_key text not null,
  region text default 'us-east-1',
  plan text check (plan in ('free', 'pro', 'team', 'enterprise')) default 'free',
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ø–æ–ª—è
create table if not exists extension_field_definitions (
  id bigserial primary key,
  tenant_id text references tenants(tenant_id) on delete cascade,
  entity_table text not null,
  field_name text not null,
  field_type text check (field_type in ('text', 'number', 'boolean', 'date', 'json', 'select')),
  display_name text not null,
  description text,
  is_required boolean default false,
  is_searchable boolean default true,
  is_filterable boolean default true,
  is_sortable boolean default false,
  default_value text,
  validation_rules jsonb default '{}',
  ui_config jsonb default '{}',
  is_active boolean default true,
  created_at timestamptz default now(),
  updated_at timestamptz default now(),
  unique(tenant_id, entity_table, field_name)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_tenants_status ON tenants(status);
CREATE INDEX IF NOT EXISTS idx_tenants_slug ON tenants(slug);
CREATE INDEX IF NOT EXISTS idx_tenant_configs_tenant ON tenant_supabase_configs(tenant_id);
CREATE INDEX IF NOT EXISTS idx_extension_fields_tenant ON extension_field_definitions(tenant_id, entity_table);
```

### –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è tenant DB:

```sql
-- create_tenant_db.sql
-- –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞

-- –°–æ–∑–¥–∞–Ω–∏–µ –ë–î
CREATE DATABASE tenant_{tenant_id};

-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–æ–≤–æ–π –ë–î
\c tenant_{tenant_id}

-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

CREATE TABLE IF NOT EXISTS clients (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  email TEXT UNIQUE,
  phone TEXT,
  custom_fields JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS projects (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  client_id UUID REFERENCES clients(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  status TEXT DEFAULT 'active',
  custom_fields JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  description TEXT,
  custom_fields JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è tenant DB
CREATE INDEX IF NOT EXISTS idx_clients_email ON clients(email);
CREATE INDEX IF NOT EXISTS idx_projects_client ON projects(client_id);
CREATE INDEX IF NOT EXISTS idx_activities_project ON activities(project_id);
CREATE INDEX IF NOT EXISTS idx_custom_fields ON clients USING gin(custom_fields);
CREATE INDEX IF NOT EXISTS idx_custom_fields_projects ON projects USING gin(custom_fields);
```

---

## üîÑ Flow –†–∞–±–æ—Ç—ã

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–µ–Ω–∞–Ω—Ç–∞:

```mermaid
graph TD
    A[API Request] --> B[Validate Data]
    B --> C[Create in Admin DB]
    C --> D[Create Tenant DB]
    D --> E[Insert Config]
    E --> F[Return Success]
```

### 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–Ω–∞–Ω—Ç–∞:

```mermaid
graph TD
    A[Request] --> B[Check Cache]
    B -->|Miss| C[Query Admin DB]
    C --> D[Get Tenant Config]
    D --> E[Connect to Tenant DB]
    E --> F[Query Data]
    F --> G[Cache Result]
    G --> H[Return Data]
    B -->|Hit| H
```

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π flow:

```typescript
// src/services/tenant-management/src/flows/createTenant.ts
import { createConnector } from '../connectors/factory';
import { createCacheService } from '../cache';

export const createTenantFlow = async (tenantData: CreateTenantData) => {
  const adminConnector = createConnector({
    type: 'supabase',
    url: process.env.ADMIN_SUPABASE_URL!,
    key: process.env.ADMIN_SERVICE_KEY!
  });
  
  const cache = createCacheService({ ttl: 600000 });
  
  try {
    // 1. –°–æ–∑–¥–∞—Ç—å —Ç–µ–Ω–∞–Ω—Ç –≤ Admin DB
    const tenant = await adminConnector.insert('tenants', tenantData);
    
    // 2. –°–æ–∑–¥–∞—Ç—å tenant DB
    await createTenantDatabase(tenant.tenant_id);
    
    // 3. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    await adminConnector.insert('tenant_supabase_configs', {
      tenant_id: tenant.tenant_id,
      ...tenantData.config
    });
    
    // 4. –ò–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫—ç—à
    cache.clear();
    
    return { success: true, tenant };
  } catch (error) {
    return { success: false, error: error.message };
  }
};
```

---

## üîß –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –ü–æ–ª—è

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

```typescript
// src/services/tenant-management/src/extensibleFields.ts
export type ExtensibleField = {
  tenant_id: string;
  entity_table: string;
  field_name: string;
  field_type: 'text' | 'number' | 'boolean' | 'date' | 'json' | 'select';
  display_name: string;
  validation_rules: Record<string, any>;
  is_required: boolean;
};

export const createExtensibleFieldService = (adminConnector: DatabaseConnector) => ({
  getFields: async (tenantId: string, entityTable: string) => {
    const fields = await adminConnector.query(
      `SELECT * FROM extension_field_definitions 
       WHERE tenant_id = $1 AND entity_table = $2 AND is_active = true`,
      [tenantId, entityTable]
    );
    return fields;
  },
  
  validateField: (field: any, definition: ExtensibleField) => {
    const rules = definition.validation_rules;
    
    if (definition.is_required && !field) {
      return { valid: false, error: 'Field is required' };
    }
    
    if (rules.minLength && field.length < rules.minLength) {
      return { valid: false, error: `Minimum length is ${rules.minLength}` };
    }
    
    return { valid: true };
  },
  
  applyFields: (data: any, fields: ExtensibleField[]) => {
    const customFields: Record<string, any> = {};
    
    fields.forEach(field => {
      if (data[field.field_name] !== undefined) {
        customFields[field.field_name] = data[field.field_name];
      }
    });
    
    return { ...data, custom_fields: customFields };
  }
});
```

---

## ‚ö° –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫—ç—à:

```typescript
// src/services/tenant-management/src/cache/redis.ts
import { createClient } from 'redis';

export type CacheService = {
  get: <T>(key: string) => Promise<T | null>;
  set: <T>(key: string, value: T, ttl?: number) => Promise<void>;
  del: (key: string) => Promise<void>;
  clear: () => Promise<void>;
};

export const createRedisCache = (redisUrl: string): CacheService => {
  const client = createClient({ url: redisUrl });
  
  return {
    get: async <T>(key: string) => {
      const value = await client.get(key);
      return value ? JSON.parse(value) : null;
    },
    
    set: async <T>(key: string, value: T, ttl = 600) => {
      await client.setex(key, ttl, JSON.stringify(value));
    },
    
    del: async (key: string) => {
      await client.del(key);
    },
    
    clear: async () => {
      await client.flushall();
    }
  };
};

// –ö—ç—à-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
export const cacheStrategies = {
  tenant: (tenantId: string) => `tenant:${tenantId}`,
  config: (tenantId: string) => `config:${tenantId}`,
  fields: (tenantId: string, entity: string) => `fields:${tenantId}:${entity}`,
  list: (offset: number, limit: number) => `list:${offset}:${limit}`
};
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –∏ health checks:

```typescript
// src/services/tenant-management/src/monitoring.ts
export type HealthCheck = {
  name: string;
  status: 'healthy' | 'unhealthy';
  message?: string;
  timestamp: string;
};

export const createHealthService = (adminConnector: DatabaseConnector) => ({
  checkAdminDB: async (): Promise<HealthCheck> => {
    try {
      await adminConnector.query('SELECT 1');
      return {
        name: 'admin_db',
        status: 'healthy',
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      return {
        name: 'admin_db',
        status: 'unhealthy',
        message: error.message,
        timestamp: new Date().toISOString()
      };
    }
  },
  
  checkTenantDB: async (tenantId: string) => {
    try {
      const config = await getTenantConfig(tenantId);
      const connector = createConnector(config);
      await connector.query('SELECT 1');
      
      return {
        name: `tenant_db_${tenantId}`,
        status: 'healthy',
        timestamp: new Date().toISOString()
      };
    } catch (error) {
      return {
        name: `tenant_db_${tenantId}`,
        status: 'unhealthy',
        message: error.message,
        timestamp: new Date().toISOString()
      };
    }
  }
});
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
npm install @supabase/supabase-js redis
npm install -D @types/redis
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
# .env
ADMIN_SUPABASE_URL=https://your-project.supabase.co
ADMIN_SERVICE_KEY=your-service-key
REDIS_URL=redis://localhost:6379
```

### 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```typescript
// src/services/tenant-management/index.ts
import { createConnector } from './connectors/factory';
import { createRedisCache } from './cache/redis';
import { createTenantService } from './services/tenantService';

const adminConnector = createConnector({
  type: 'supabase',
  url: process.env.ADMIN_SUPABASE_URL!,
  key: process.env.ADMIN_SERVICE_KEY!
});

const cache = createRedisCache(process.env.REDIS_URL!);
const tenantService = createTenantService({ adminConnector, cache });

export { tenantService };
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/services/tenant-management/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase-client.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ queries.ts
‚îÇ   ‚îú‚îÄ‚îÄ connectors/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ factory.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postgres.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts
‚îÇ   ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ memory.ts
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenantService.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ extensibleFields.ts
‚îÇ   ‚îú‚îÄ‚îÄ validation/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îú‚îÄ‚îÄ monitoring/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.ts
‚îÇ   ‚îî‚îÄ‚îÄ types/
‚îÇ       ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ sql/
‚îÇ   ‚îú‚îÄ‚îÄ init_admin_db.sql
‚îÇ   ‚îî‚îÄ‚îÄ create_tenant_db.sql
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ unit/
    ‚îî‚îÄ‚îÄ integration/
```

---

## üéØ –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏

1. **–ú–∏–≥—Ä–∞—Ü–∏—è AdminDB** ‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏–∑ `lib/adminDb` –≤ `tenant-management/src/database`
2. **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤** ‚Üí –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Postgres, MongoDB
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí –ù–∞–ø–∏—Å–∞—Ç—å unit –∏ integration —Ç–µ—Å—Ç—ã
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API** ‚Üí OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** ‚Üí –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –∞–ª–µ—Ä—Ç—ã

---

**–§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**: `messiah-multitenant-guide.md`
–°–∫–∞—á–∞—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ IDE –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É: `cp docs/messiah-multitenant-guide.md ~/Desktop/`
