# Руководство по Реализации Мультитенантной Платформы “Мессия”

**Дата:** 24 июля 2025  
**Модель:**-per-Tenant + Admin DB для метаданных и настроек

---

## Содержание

1. [Общая Архитектура](#общая-архитектура)
2. [Схема Admin DB (конфигурации)](#схема-admin-db)
3. [Схема Tenant DB (данные клиента)](#схема-tenant-db)
4. [SQL-скрипты создания схемы](#sql-скрипты)
5. [Порядок работы (Flow)](#flow)
6. [Механизм расширяемых полей и настроек](#extensible-fields)
7. [API и миграции](#api-и-миграции)
8. [Кэширование и производительность](#кэширование)

---

<a name="общая-архитектура"></a>

## 1. Общая Архитектура

- **Admin DB** (shared)  
  – Хранит глобальные и per-tenant метаданные, системные настройки, расширяемые поля.
- **Tenant DB** (по одной базе на каждого клиента)  
  – Содержит бизнес-данные: сущности, per-tenant overrides, пользовательские настройки.

**Преимущества:**

- Полная изоляция данных
- Гибкость в добавлении новых полей и настроек
- Отсутствие DDL-миграций в Tenant DB

---

<a name="схема-admin-db"></a>

## 2. Схема Admin DB (конфигурации)

```

-- 1. Таблица тенантов
CREATE TABLE tenants (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
name TEXT NOT NULL,
code TEXT UNIQUE NOT NULL,
status VARCHAR(20) NOT NULL DEFAULT 'active',
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Конфигурации подключений к Tenant DB
CREATE TABLE tenant_database_configs (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
connector_type VARCHAR(20) NOT NULL
CHECK (connector_type IN ('postgres','mysql','mongodb','sqlserver')),
host TEXT NOT NULL,
port INT NOT NULL,
db_name TEXT NOT NULL,
username TEXT NOT NULL,
password TEXT NOT NULL,
is_active BOOLEAN DEFAULT true,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
UNIQUE (tenant_id)
);

-- 3. Глобальные системные настройки
CREATE TABLE system_settings (
key TEXT PRIMARY KEY,
value JSONB NOT NULL,
description TEXT,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Пер-тенантовые системные настройки
CREATE TABLE tenant_settings (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
key TEXT NOT NULL,
value JSONB NOT NULL,
description TEXT,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
UNIQUE (tenant_id, key)
);

-- 5. Метаданные extensible-полей
CREATE TABLE tenant_custom_fields (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
entity_type TEXT NOT NULL,
field_name TEXT NOT NULL,
field_type VARCHAR(20) NOT NULL
CHECK (field_type IN ('text','number','boolean','date','json','select')),
display_name TEXT NOT NULL,
description TEXT,
is_required BOOLEAN DEFAULT false,
is_searchable BOOLEAN DEFAULT false,
is_filterable BOOLEAN DEFAULT false,
is_sortable BOOLEAN DEFAULT false,
display_order INT DEFAULT 100,
is_visible BOOLEAN DEFAULT true,
is_active BOOLEAN DEFAULT true,
default_value JSONB,
validation_rules JSONB DEFAULT '{}'::JSONB,
ui_config JSONB DEFAULT '{}'::JSONB,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 6. Feature flags и права
CREATE TABLE feature_flags (
tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
feature_key TEXT NOT NULL,
is_enabled BOOLEAN DEFAULT false,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
PRIMARY KEY (tenant_id, feature_key)
);

CREATE TABLE roles_permissions (
tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
role_key TEXT NOT NULL,
permissions JSONB NOT NULL,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
PRIMARY KEY (tenant_id, role_key)
);

```

---

<a name="схема-tenant-db"></a>

## 3. Схема Tenant DB (данные клиента)

Каждая Tenant DB содержит обычные бизнес-сущности и JSONB-колонку `custom_fields`:

```

CREATE TABLE users (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
email TEXT UNIQUE NOT NULL,
password_hash TEXT NOT NULL,
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
custom_fields JSONB DEFAULT '{}'::JSONB
);

CREATE TABLE leads (
id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
name TEXT NOT NULL,
status VARCHAR(20),
created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
custom_fields JSONB DEFAULT '{}'::JSONB
);

-- Аналогично для clients, projects, activities и т.д.

```

**Опционально:**

```

-- Per-user настройки
CREATE TABLE user_preferences (
user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
preferences JSONB NOT NULL,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

```

---

<a name="sql-скрипты"></a>

## 4. SQL-скрипты создания схемы

1. Настройка расширений:

```

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

```

2. Выполнить блоки из разделов [Схема Admin DB](#схема-admin-db) и [Схема Tenant DB](#схема-tenant-db).

3. Проверить индексы GIN для JSONB:

```

CREATE INDEX ON users USING GIN (custom_fields);
CREATE INDEX ON leads USING GIN (custom_fields);

```

---

<a name="flow"></a>

## 5. Порядок Работы (Flow)

1. **Регистрация тенанта**

- В Admin DB: вставка в `tenants` и `tenant_database_configs`.

2. **Инициализация Tenant DB**

- Автоматический скрипт создаёт схемы и таблицы в новой базе.

3. **Загрузка Метаданных**

- Сервис на старте подгружает из Admin DB:
  - `tenant_custom_fields`, `tenant_settings`, `feature_flags`.
- Кэшировать в Redis.

4. **Операции CRUD**

- Бизнес-данные → Tenant DB, JSONB-поля заполняются расширяемыми данными.
- Системные per-tenant → Admin DB `tenant_settings`.

5. **Обновление Метаданных**

- В Admin-панели CRUD над `tenant_custom_fields` и `tenant_settings`.
- Авто-применение без миграций Tenant DB.

---

<a name="extensible-fields"></a>

## 6. Механизм Расширяемых Полей и Настроек

1. **Admin DB → tenant_custom_fields**  
   Модель TypeScript:

```

interface ExtensionFieldDefinition {
id: string;
tenant_id: string;
entity_type: string;
field_name: string;
field_type: 'text'|'number'|'boolean'|'date'|'json'|'select';
display_name: string;
description?: string;
is_required: boolean;
is_searchable: boolean;
is_filterable: boolean;
is_sortable: boolean;
display_order: number;
is_visible: boolean;
is_active: boolean;
default_value?: any;
validation_rules?: Record<string, any>;
ui_config?: Record<string, any>;
created_at: string;
updated_at: string;
}

```

2. **Tenant DB → JSONB**

- При сохранении: маппинг полей в объект JSON, валидация по `validation_rules`.

3. **Поиск/Фильтрация**

- Индексы GIN + операторы `@>`, `->>`, `?`.

---

<a name="api-и-миграции"></a>

## 7. API и Миграции

### Примеры маршрут в Express.js (TypeScript)

```

// Получить настройки tenant
router.get('/admin/tenants/:tenantId/settings', async (req, res) => {
const { tenantId } = req.params;
const settings = await db.admin.tenant_settings.findMany({ where: { tenant_id: tenantId } });
res.json(settings);
});

// Обновить расширяемые поля
router.post('/admin/tenants/:tenantId/fields', async (req, res) => {
const defs = req.body as ExtensionFieldDefinition[];
await db.admin.tenant_custom_fields.upsert({ data: defs });
res.sendStatus(204);
});

```
